<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Yeraltƒ± ≈ûehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { background:#0b0b0b; color:#fff; font-family:Arial; padding:20px }
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1e1e1e;color:#fff;border:none;border-radius:6px;font-size:16px}
.box{background:#151515;padding:15px;border-radius:8px;margin-top:15px}
.hidden{display:none}
.success{color:#4caf50}
.error{color:#f44336}
</style>
</head>

<body>

<h1>üî• Yeraltƒ± ≈ûehri</h1>

<div class="box" id="playerInfo">Y√ºkleniyor...</div>

<button onclick="show('missions')">üí£ G√∂revler</button>
<button onclick="show('shop')">üõí Satƒ±n Alƒ±m</button>
<button onclick="hospital()">üè• Hastane</button>

<div id="missions" class="box hidden"></div>
<div id="shop" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
// ================== SUPABASE ==================
const supabase = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const TELEGRAM_ID = "162154220";

// ================== UI ==================
function show(id){
  document.querySelectorAll('.box').forEach(b=>b.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// ================== PLAYER ==================
async function loadPlayer(){
  const { data, error } = await supabase
    .from("players")
    .select("*")
    .eq("telegram_id", TELEGRAM_ID)
    .single();

  if(error){
    document.getElementById("playerInfo").innerHTML="Oyuncu bulunamadƒ±";
    return;
  }

  document.getElementById("playerInfo").innerHTML = `
    <b>Karakter:</b> ${data.character}<br>
    <b>Level:</b> ${data.level}<br>
    <b>XP:</b> ${data.xp}<br>
    <b>Enerji:</b> ${data.energy}<br>
    <b>YTon:</b> ${data.yton}
  `;
}

// ================== MISSIONS ==================
async function loadMissions(){
  show("missions");
  const box = document.getElementById("missions");
  box.innerHTML = "G√∂revler y√ºkleniyor...";

  const { data } = await supabase
    .from("missions")
    .select("*")
    .eq("active", true);

  box.innerHTML = "<h3>G√∂revler</h3>";

  data.forEach(m=>{
    box.innerHTML += `
      <button onclick="doMission(${m.id})">
        ${m.name}<br>
        Enerji: ${m.energy_cost} | Risk: %${m.risk_percent} | √ñd√ºl: ${m.yton_reward}
      </button>
    `;
  });
}

async function doMission(id){
  const { data } = await supabase.rpc("do_mission", {
    p_telegram_id: TELEGRAM_ID,
    p_mission_id: id
  });

  show("result");
  document.getElementById("result").innerHTML =
    data?.error
      ? `<div class="error">${data.error}</div>`
      : `<div class="success">G√∂rev tamamlandƒ±</div>`;

  loadPlayer();
}

// ================== SHOP ==================
async function loadShop(){
  show("shop");
  const box = document.getElementById("shop");
  box.innerHTML = "<h3>Satƒ±n Alƒ±m</h3>";

  const items = [
    {id:1,name:"Tabanca",price:50},
    {id:2,name:"Alkol",price:10},
    {id:3,name:"Uyu≈üturucu",price:30}
  ];

  items.forEach(i=>{
    box.innerHTML += `
      <button onclick="buy(${i.id})">
        ${i.name} - ${i.price} YTon
      </button>
    `;
  });
}

async function buy(id){
  const { data } = await supabase.rpc("buy_item", {
    p_telegram_id: TELEGRAM_ID,
    p_item_id: id
  });

  show("result");
  document.getElementById("result").innerHTML =
    data?.error
      ? `<div class="error">${data.error}</div>`
      : `<div class="success">Satƒ±n alƒ±ndƒ±</div>`;

  loadPlayer();
}

// ================== HOSPITAL ==================
async function hospital(){
  const { data } = await supabase.rpc("hospital_heal", {
    p_telegram_id: TELEGRAM_ID
  });

  show("result");
  document.getElementById("result").innerHTML =
    data?.error
      ? `<div class="error">${data.error}</div>`
      : `<div class="success">ƒ∞yile≈ütirildin</div>`;

  loadPlayer();
}

// ================== INIT ==================
loadPlayer();
</script>

</body>
</html>
