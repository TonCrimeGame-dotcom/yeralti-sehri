<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1a1a1a;color:#fff;border:none;border-radius:8px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
small{opacity:.7}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="player" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="openPvP()">âš”ï¸ PvP</button>
<button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>

<div id="content" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
 async function loadPvPQuestion(){
 const {data}=await sb
  .from("pvp_questions")
  .select("*")
  .order("random()")
  .limit(1)
  .single();

 window.pvpStartTime = Date.now();

 show(`
  <b>âš”ï¸ PvP</b>
  <img src="${data.image_url}" style="width:100%;border-radius:8px">
  <p>${data.question}</p>
  <button onclick="answerPvP(${data.id},'A')">A) ${data.option_a}</button>
  <button onclick="answerPvP(${data.id},'B')">B) ${data.option_b}</button>
  <button onclick="answerPvP(${data.id},'C')">C) ${data.option_c}</button>
  <button onclick="answerPvP(${data.id},'D')">D) ${data.option_d}</button>
 `);
}

async function answerPvP(id,answer){
 let time = Math.floor((Date.now()-window.pvpStartTime)/1000);

 const {data}=await sb.rpc("pvp_answer",{
  p_telegram_id:TELEGRAM_ID,
  p_question_id:id,
  p_answer:answer,
  p_time:time
 });

 result(
  data.result==="win"
   ? `ğŸ† KazandÄ±n! +${data.yton} YTon +${data.xp} XP`
   : `âŒ Kaybettin! ${data.yton} YTon`
 );
}
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://hwhscuyudwphnsipibpy.supabase.co",
 "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);
const TELEGRAM_ID = "162154220";

/* ================= UI ================= */
function show(html){
 const c=document.getElementById("content");
 c.innerHTML=html;
 c.classList.remove("hidden");
 document.getElementById("result").classList.add("hidden");
}
function result(msg){
 document.getElementById("result").innerHTML=msg;
 document.getElementById("result").classList.remove("hidden");
 loadPlayer();
}

/* ================= PLAYER ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
  .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("player").innerHTML=`
 <b>Level:</b> ${data.level} |
 <b>XP:</b> ${data.xp}<br>
 <b>Enerji:</b> ${data.energy} |
 <b>YTon:</b> ${data.yton}
 `;
}

/* ================= GÃ–REVLER ================= */
async function loadMissions(){
 const {data}=await sb.from("missions")
  .select("*").eq("active",true);

 if(!data||!data.length){
  show("<b>ğŸ’£ Aktif gÃ¶rev yok</b>");
  return;
 }

 let h="<b>ğŸ’£ GÃ¶revler</b>";
 data.forEach(m=>{
  h+=`
   <button onclick="doMission(${m.id})">
    ${m.name} â€“ Enerji ${m.energy_cost}
   </button>
   <small>XP ${m.xp_reward} | YTon ${m.yton_reward}</small>
  `;
 });
 show(h);
}

async function doMission(id){
 const {data}=await sb.rpc("do_mission",{
  p_telegram_id:TELEGRAM_ID,
  p_mission_id:id
 });
 if(data?.error){ result("âŒ "+data.error); }
 else if(data.success){ result("âœ… GÃ¶rev baÅŸarÄ±lÄ±"); }
 else{ result("âŒ GÃ¶rev baÅŸarÄ±sÄ±z"); }
}

/* ================= PvP ================= */
function openPvP(){
 show(`
 <b>âš”ï¸ PvP</b>
 <button onclick="playPvP('easy',true)">Kolay â€“ DoÄŸru</button>
 <button onclick="playPvP('easy',false)">Kolay â€“ YanlÄ±ÅŸ</button>
 <button onclick="playPvP('medium',true)">Orta â€“ DoÄŸru</button>
 <button onclick="playPvP('hard',false)">Zor â€“ YanlÄ±ÅŸ</button>
 <small>Bu sÃ¼rÃ¼m mantÄ±k testidir</small>
 `);
}

async function playPvP(diff,correct){
 const {data}=await sb.rpc("pvp_play",{
  p_telegram_id:TELEGRAM_ID,
  p_difficulty:diff,
  p_correct:correct
 });
 if(data.result==="win") result("ğŸ† PvP KazanÄ±ldÄ±");
 else result("âŒ PvP Kaybedildi");
}

/* ================= GECE HAYATI ================= */
function openNightlife(){
 show(`
 <b>ğŸŒƒ Gece HayatÄ±</b>
 <p>Gece kulÃ¼bÃ¼, coffee shop ve genel ev aktif.</p>
 <small>ÃœrÃ¼nler bir sonraki adÄ±mda baÄŸlanacak</small>
 `);
}

/* ================= SÄ°LAH KAÃ‡AKÃ‡ISI ================= */
function openWeapons(){
 show(`
 <b>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</b>
 <p>Silahlar backendâ€™e baÄŸlÄ±.</p>
 <small>Bir sonraki adÄ±mda satÄ±n alma eklenecek</small>
 `);
}

/* ================= HASTANE ================= */
async function hospital(){
 const {data}=await sb.rpc("hospital_heal",{p_telegram_id:TELEGRAM_ID});
 result("â¤ï¸ Enerji dolduruldu");
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
