<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { background:#0b0b0b; color:#fff; font-family:Arial; padding:20px }
h1 { text-align:center }
.box { background:#151515; padding:15px; border-radius:8px; margin-bottom:15px }
button { width:100%; padding:14px; margin:6px 0; background:#1e1e1e; color:#fff; border:none; border-radius:6px; font-size:16px }
button:hover { background:#333 }
.hidden { display:none }
.success { color:#4caf50 }
.error { color:#f44336 }
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri (+19)</h1>

<div class="box" id="player">YÃ¼kleniyor...</div>

<button onclick="openBox('missions')">ğŸ’£ GÃ¶rev Yap</button>
<button onclick="openBox('weapons')">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>
<button onclick="openBox('nightlife')">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openBox('hospital')">ğŸ¥ Hastane</button>

<div id="missions" class="box hidden"></div>
<div id="weapons" class="box hidden"></div>
<div id="nightlife" class="box hidden"></div>
<div id="hospital" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const TELEGRAM_ID = "162154220";

/* ===== UI ===== */
function openBox(id){
  document.querySelectorAll(".box").forEach(b=>b.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* ===== PLAYER ===== */
async function loadPlayer(){
  const { data } = await sb
    .from("players")
    .select("*")
    .eq("telegram_id", TELEGRAM_ID)
    .single();

  document.getElementById("player").innerHTML =
    `<b>Karakter:</b> ${data.character}<br>
     <b>Level:</b> ${data.level}<br>
     <b>XP:</b> ${data.xp}<br>
     <b>Enerji:</b> ${data.energy}<br>
     <b>YTon:</b> ${data.yton}`;
}

/* ===== MISSIONS ===== */
async function loadMissions(){
  const { data } = await sb.from("missions").select("*").eq("active", true);
  let html = "<h3>GÃ¶revler</h3>";

  if(!data.length) html += "GÃ¶rev yok";

  data.forEach(m=>{
    html += `<button onclick="doMission(${m.id})">${m.name} | Risk %${m.risk_percent}</button>`;
  });

  document.getElementById("missions").innerHTML = html;
}

async function doMission(id){
  const { data } = await sb.rpc("do_mission", {
    p_telegram_id: TELEGRAM_ID,
    p_mission_id: id
  });

  showResult(data?.error ? data.error : "GÃ¶rev baÅŸarÄ±lÄ±");
  loadPlayer();
}

/* ===== BUY ===== */
async function buy(id){
  const { data } = await sb.rpc("buy_item", {
    p_telegram_id: TELEGRAM_ID,
    p_item_id: id
  });

  showResult(data?.error ? data.error : "SatÄ±n alÄ±ndÄ±");
  loadPlayer();
}

/* ===== HOSPITAL ===== */
async function heal(){
  const { data } = await sb.rpc("hospital_heal", {
    p_telegram_id: TELEGRAM_ID
  });

  showResult(data?.error ? data.error : "Ä°yileÅŸtirildin");
  loadPlayer();
}

/* ===== RESULT ===== */
function showResult(msg){
  document.getElementById("result").classList.remove("hidden");
  document.getElementById("result").innerHTML =
    msg.includes("error") ? `<span class="error">${msg}</span>` :
    `<span class="success">${msg}</span>`;
}

/* ===== STATIC MENUS ===== */
document.getElementById("weapons").innerHTML = `
<h3>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</h3>
<button onclick="buy(30)">Tabanca</button>
<button onclick="buy(31)">PompalÄ±</button>
<button onclick="buy(32)">AK-47</button>
`;

document.getElementById("nightlife").innerHTML = `
<h3>ğŸŒƒ Gece KulÃ¼bÃ¼</h3>
<button onclick="buy(10)">Bira</button>
<button onclick="buy(11)">Votka</button>

<h3>â˜• Coffee Shop</h3>
<button onclick="buy(20)">Ot</button>
<button onclick="buy(21)">Mantar</button>
`;

document.getElementById("hospital").innerHTML =
  `<button onclick="heal()">Tedavi Ol</button>`;

/* ===== INIT ===== */
loadPlayer();
loadMissions();
</script>

</body>
</html>
