<script>
/* ================= ETKƒ∞ Sƒ∞STEMƒ∞ ================= */

/* ---- GLOBAL MODIFIERS ---- */
let modifiers = JSON.parse(localStorage.getItem("modifiers")) || {
 success: 0,
 risk: 0,
 energyBonus: 0
};

function saveModifiers(){
 localStorage.setItem("modifiers",JSON.stringify(modifiers));
}

/* ---- BUY OVERRIDE (ETKƒ∞Lƒ∞) ---- */
async function buy(id){
 const {data}=await sb.rpc("buy_item",{
  p_telegram_id:TELEGRAM_ID,
  p_item_id:id
 });

 if(!data?.error){
  applyItemEffect(id);
 }

 showResult(data?.error || "Satƒ±n alƒ±ndƒ±");
}

/* ---- ITEM EFFECTS ---- */
function applyItemEffect(id){

 /* üî´ Sƒ∞LAHLAR */
 if(id>=600 && id<=699){
  modifiers.success += 5;
  modifiers.risk -= 2;
 }

 /* üç∏ ƒ∞√áKƒ∞ */
 if(id>=100 && id<=129){
  modifiers.energyBonus += 3;
  modifiers.risk += 1;
 }

 /* ‚òï UYU≈ûTURUCU */
 if(id>=200 && id<=229){
  modifiers.success += 4;
  modifiers.risk += 2;
 }

 /* üíã GENEL EV */
 if(id>=300 && id<=599){
  modifiers.success += 6;
  modifiers.energyBonus += 5;
  modifiers.risk += 1;
 }

 saveModifiers();
}

/* ================= G√ñREV OVERRIDE ================= */
async function doMission(id){

 let finalSuccess = 50 + modifiers.success;
 let finalRisk = Math.max(0, 20 + modifiers.risk);

 let roll = Math.random()*100;

 if(roll > finalSuccess){
  modifiers.energyBonus = 0;
  modifiers.success = Math.max(0, modifiers.success-3);
  modifiers.risk += 1;
  saveModifiers();
  showResult("‚ùå G√∂rev ba≈üarƒ±sƒ±z (Risk √ßok y√ºksekti)");
  return;
 }

 const {data}=await sb.rpc("do_mission",{
  p_telegram_id:TELEGRAM_ID,
  p_mission_id:id
 });

 modifiers.energyBonus = 0;
 modifiers.success = Math.max(0, modifiers.success-2);
 modifiers.risk = Math.max(0, modifiers.risk-1);
 saveModifiers();

 showResult(data?.error || "‚úÖ G√∂rev ba≈üarƒ±yla tamamlandƒ±");
}

/* ================= PLAYER G√ñSTERGE ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
  .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("playerInfo").innerHTML=
 `Enerji: ${data.energy + modifiers.energyBonus}
 | YTon: ${data.yton}
 <br><small>
 Ba≈üarƒ± Bonus: +${modifiers.success}% |
 Risk: ${modifiers.risk}
 </small>`;
}
</script>
