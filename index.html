<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
  background:#0b0b0b;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:20px;
}
h1{text-align:center}
.box{
  background:#151515;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
}
button{
  width:100%;
  padding:14px;
  margin:6px 0;
  background:#1e1e1e;
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:16px;
}
button:hover{background:#333}
.hidden{display:none}
.success{color:#4caf50}
.error{color:#f44336}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<div class="box">
  <button onclick="openMissions()">ğŸ’£ GÃ¶revler</button>
  <button onclick="openShop()">ğŸ›’ SatÄ±n AlÄ±m</button>
  <button onclick="openHospital()">ğŸ¥ Hastane</button>
  <button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
  <button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>
</div>

<div id="missions" class="box hidden"></div>
<div id="shop" class="box hidden"></div>
<div id="hospital" class="box hidden"></div>
<div id="nightlife" class="box hidden"></div>
<div id="weapons" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const TELEGRAM_ID = "162154220";

/* ================= UTIL ================= */
function hideAll(){
  document.querySelectorAll(".box").forEach(b=>{
    if(b.id!=="playerInfo") b.classList.add("hidden");
  });
}
function showBox(id){
  hideAll();
  document.getElementById(id).classList.remove("hidden");
}
function showResult(msg,isErr=false){
  const r=document.getElementById("result");
  r.classList.remove("hidden");
  r.innerHTML=`<div class="${isErr?'error':'success'}">${msg}</div>`;
}

/* ================= PLAYER ================= */
async function loadPlayer(){
  const { data, error } = await sb
    .from("players")
    .select("*")
    .eq("telegram_id", TELEGRAM_ID)
    .single();

  if(error){
    document.getElementById("playerInfo").innerHTML="Oyuncu bulunamadÄ±";
    return;
  }

  document.getElementById("playerInfo").innerHTML=`
    <b>Karakter:</b> ${data.character}<br>
    <b>Level:</b> ${data.level}<br>
    <b>XP:</b> ${data.xp}<br>
    <b>Enerji:</b> ${data.energy}<br>
    <b>YTon:</b> ${data.yton}
  `;
}

/* ================= MISSIONS ================= */
async function openMissions(){
  showBox("missions");
  const box=document.getElementById("missions");
  box.innerHTML="<b>GÃ¶revler</b><br>";

  const { data } = await sb.from("missions").select("*").eq("active",true);

  if(!data || data.length===0){
    box.innerHTML+="GÃ¶rev yok";
    return;
  }

  data.forEach(m=>{
    box.innerHTML+=`
      <button onclick="doMission(${m.id})">
        ${m.name} (+${m.yton_reward} YTon)
      </button>`;
  });
}

async function doMission(id){
  const { data } = await sb.rpc("do_mission",{
    p_telegram_id: TELEGRAM_ID,
    p_mission_id: id
  });
  showResult(data?.error ?? "GÃ¶rev tamamlandÄ±", !!data?.error);
  loadPlayer();
}

/* ================= SHOP ================= */
function openShop(){
  showBox("shop");
  document.getElementById("shop").innerHTML=`
    <b>SatÄ±n AlÄ±m</b>
    <button onclick="buy(11)">ğŸº Alkol (10)</button>
    <button onclick="buy(21)">ğŸŒ¿ UyuÅŸturucu (30)</button>
  `;
}

/* ================= WEAPONS ================= */
function openWeapons(){
  showBox("weapons");
  document.getElementById("weapons").innerHTML=`
    <b>Silah KaÃ§akÃ§Ä±sÄ±</b>
    <button onclick="buy(31)">ğŸ”« Tabanca (50)</button>
    <button onclick="buy(32)">ğŸ’¥ PompalÄ± (80)</button>
  `;
}

/* ================= NIGHTLIFE ================= */
function openNightlife(){
  showBox("nightlife");
  document.getElementById("nightlife").innerHTML=`
    <b>Gece KulÃ¼bÃ¼</b>
    <button onclick="buy(11)">ğŸ¸ Votka</button>
    <hr>
    <b>Coffee Shop</b>
    <button onclick="buy(21)">ğŸŒ¿ Ot</button>
  `;
}

/* ================= BUY ================= */
async function buy(id){
  const { data } = await sb.rpc("buy_item",{
    p_telegram_id: TELEGRAM_ID,
    p_item_id: id
  });
  showResult(data?.error ?? "SatÄ±n alÄ±ndÄ±", !!data?.error);
  loadPlayer();
}

/* ================= HOSPITAL ================= */
function openHospital(){
  showBox("hospital");
  document.getElementById("hospital").innerHTML=`
    <b>Hastane</b>
    <button onclick="heal()">Tedavi Ol</button>
  `;
}

async function heal(){
  const { data } = await sb.rpc("hospital_heal",{
    p_telegram_id: TELEGRAM_ID
  });
  showResult(data?.error ?? "Ä°yileÅŸtirildin", !!data?.error);
  loadPlayer();
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
