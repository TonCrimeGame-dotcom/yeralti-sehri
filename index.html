<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1a1a1a;color:#fff;border:none;border-radius:8px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
small{display:block;opacity:.7;margin-bottom:8px}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>
<button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>

<div id="missions" class="box hidden"></div>
<div id="nightlife" class="box hidden"></div>
<div id="weapons" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://hwhscuyudwphnsipibpy.supabase.co",
 "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);
const TELEGRAM_ID="162154220";

/* ================= MODIFIERS ================= */
let modifiers = JSON.parse(localStorage.getItem("modifiers")) || {
 success: 0,
 risk: 0,
 energyBonus: 0,
 addiction: 0,
 weaponDurability: 0
};
function saveModifiers(){
 localStorage.setItem("modifiers",JSON.stringify(modifiers));
}

/* ================= UI ================= */
function showBox(id){
 document.querySelectorAll(".box").forEach(b=>b.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}
function showResult(msg){
 document.getElementById("result").innerHTML=msg;
 showBox("result");
 loadPlayer();
}

/* ================= PLAYER ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
  .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("playerInfo").innerHTML=`
 Enerji: ${data.energy + modifiers.energyBonus} |
 YTon: ${data.yton}<br>
 <small>
 ğŸ¯ BaÅŸarÄ±: +${modifiers.success}% |
 âš ï¸ Risk: ${modifiers.risk} |
 â˜ ï¸ BaÄŸÄ±mlÄ±lÄ±k: ${modifiers.addiction} |
 ğŸ”« Silah: ${modifiers.weaponDurability}%
 </small>`;
}

/* ================= BUY ================= */
async function buy(id){
 const {data}=await sb.rpc("buy_item",{
  p_telegram_id:TELEGRAM_ID,
  p_item_id:id
 });

 if(!data?.error) applyItemEffect(id);
 showResult(data?.error || "SatÄ±n alÄ±ndÄ±");
}

/* ================= ITEM EFFECTS ================= */
function applyItemEffect(id){
 if(id>=600 && id<=699){
  modifiers.success += 5;
  modifiers.risk = Math.max(0,modifiers.risk-2);
  modifiers.weaponDurability = 100;
 }
 if(id>=100 && id<=129){
  modifiers.energyBonus += 3;
  modifiers.risk += 1;
 }
 if(id>=200 && id<=229){
  modifiers.success += 4;
  modifiers.risk += 2;
  modifiers.addiction += 5;
 }
 if(id>=300 && id<=599){
  modifiers.success += 6;
  modifiers.energyBonus += 5;
  modifiers.risk += 1;
 }
 saveModifiers();
}

/* ================= GÃ–REVLER ================= */
async function loadMissions(){
 showBox("missions");
 const box=document.getElementById("missions");
 box.innerHTML="<b>ğŸ’£ GÃ¶revler</b>";

 const {data}=await sb.from("missions").select("*").eq("active",true);
 if(!data||!data.length){
  box.innerHTML+="<p>Aktif gÃ¶rev yok</p>";return;
 }
 data.forEach(m=>{
  box.innerHTML+=`
   <button onclick="doMission(${m.id})">${m.name} â€“ Enerji ${m.energy_cost}</button>
   <small>${m.description||"Riskli ama kazanÃ§lÄ±"}</small>`;
 });
}

async function doMission(id){
 let finalSuccess = 50 + modifiers.success - modifiers.addiction;
 let finalRisk = 20 + modifiers.risk + modifiers.addiction;

 if(modifiers.weaponDurability>0){
  modifiers.weaponDurability -= 10;
 }else{
  modifiers.success=Math.max(0,modifiers.success-5);
 }

 if(Math.random()*100>finalSuccess){
  modifiers.risk+=2;
  saveModifiers();
  showResult("âŒ GÃ¶rev baÅŸarÄ±sÄ±z");
  return;
 }

 const {data}=await sb.rpc("do_mission",{
  p_telegram_id:TELEGRAM_ID,
  p_mission_id:id
 });

 if(finalRisk>40 && Math.random()*100<finalRisk){
  modifiers={success:0,risk:0,energyBonus:0,addiction:0,weaponDurability:0};
  saveModifiers();
  showResult("ğŸš¨ Polis baskÄ±nÄ±! Her ÅŸey sÄ±fÄ±rlandÄ±");
  return;
 }

 modifiers.addiction=Math.max(0,modifiers.addiction-2);
 saveModifiers();
 showResult(data?.error || "âœ… GÃ¶rev baÅŸarÄ±lÄ±");
}

/* ================= GECE HAYATI ================= */
function openNightlife(){
 showBox("nightlife");
 document.getElementById("nightlife").innerHTML=`
 <b>ğŸŒƒ Gece HayatÄ±</b>
 <button onclick="openClub()">ğŸ¸ Gece KulÃ¼bÃ¼</button>
 <button onclick="openCoffee()">â˜• Coffee Shop</button>
 <button onclick="openBrothel()">ğŸ’‹ Genel Ev</button>`;
}

/* --- GECE KULÃœBÃœ --- */
const drinks=["Black Velvet","Red Sin","Midnight Vodka","Neon Tequila","Golden Whiskey","Shadow Rum","Blue Ice","Fire Gin","Poison Shot","Dark Angel","Night Queen","Cold Steel","Bloody Moon","Urban Spirit","Viper Drink","Lost Soul","Electric Lime","Silent Shot","Burning Kiss","Ice Devil","Broken Heart","Deep Blue","Noir Mix","High Voltage","Smoke Glass","Neon Flame","Street King","Black Rose","After Dark","Last Call"];
function openClub(){
 let h="<b>ğŸ¸ Gece KulÃ¼bÃ¼</b>";
 drinks.forEach((d,i)=>h+=`<button onclick="buy(${100+i})">${d} | Enerji +${2+i%4} â€“ ${10+i*2} YTon</button>`);
 h+=`<button onclick="openNightlife()">â¬… Geri</button>`;
 document.getElementById("nightlife").innerHTML=h;
}

/* --- COFFEE SHOP --- */
const drugs=["Mor Sis","KÄ±rmÄ±zÄ± Ã‡izik","Pembe Toz","Gece MantarÄ±","Beyaz Hayal","Neon Ot","Zihin ParÃ§asÄ±","Kara Ã‡amur","Mavi Kristal","Sokak Åekeri","Derin Kafa","GÃ¶lgeli Hap","Kafesiz","AteÅŸ Tozu","RÃ¼ya YapraÄŸÄ±","Zombi KarÄ±ÅŸÄ±m","YÃ¼ksek Bulut","Ã‡arpÄ±k MantÄ±k","SÄ±vÄ± Gece","Alt Beyin","Parazit","BulanÄ±k Hat","Frekans","Sersem","KaranlÄ±k Ã‡ay","Zero X","Psiko Damla","Gece Ã‡ubuÄŸu","Paranoya","Son Nefes"];
function openCoffee(){
 let h="<b>â˜• Coffee Shop</b>";
 drugs.forEach((d,i)=>h+=`<button onclick="buy(${200+i})">${d} | XP +${3+i%6} â€“ ${30+i*3} YTon</button>`);
 h+=`<button onclick="openNightlife()">â¬… Geri</button>`;
 document.getElementById("nightlife").innerHTML=h;
}

/* --- GENEL EV --- */
const women=["Mia Khalite","Lana Rains","Sasha Noir","Lola Velvet","Kira Moon","Vera Blaze","Nina Fox","Bella Storm","Ruby Kiss","Alina Frost","Eva Lux","Maya Sin","Daisy Night","Lexa Flame","Rina Dark","Tina Glow","Katy Venom","Nora Silk","Ivy Black","Mila Rose","Sienna Red","Aria Vice","Nika Poison","Lily Smoke","Zara Heat","Vixen Blue","Kora Night","Luna Vice","Tara Sin","Jade Velvet","Elena Ice","Roxy Hell","Vera Pink","Nadia Lux","Mona Kiss"];
const men=["Johnny Steel","Max Power","Leo Storm","Rick Blaze","Tony Dark","Axel Noir","Chris Venom","Duke Stone","Mark Inferno","Ivan Rush"];
const twins=["Scarlet & Violet","Luna & Nova","Ivy & Lily","Rose & Ruby","Mia & Mila"];
function openBrothel(){
 let h="<b>ğŸ’‹ Genel Ev</b><small>KadÄ±nlar</small>";
 women.forEach((n,i)=>h+=`<button onclick="buy(${300+i})">${n} â€“ ${30+i} YTon</button>`);
 h+="<small>Erkekler</small>";
 men.forEach((n,i)=>h+=`<button onclick="buy(${400+i})">${n} â€“ ${50+i*2} YTon</button>`);
 h+="<small>Ä°kizler</small>";
 twins.forEach((n,i)=>h+=`<button onclick="buy(${500+i})">${n} â€“ ${120+i*5} YTon</button>`);
 h+=`<button onclick="openNightlife()">â¬… Geri</button>`;
 document.getElementById("nightlife").innerHTML=h;
}

/* ================= SÄ°LAH KAÃ‡AKÃ‡ISI ================= */
const weapons=[
{id:600,name:"Glock 19",price:50,info:"BaÅŸarÄ± +5 | Risk -2"},
{id:601,name:"Desert Eagle",price:80,info:"YÃ¼ksek hasar"},
{id:602,name:"Uzi SMG",price:110,info:"Ã‡oklu gÃ¶rev bonus"},
{id:603,name:"AK-47",price:160,info:"Zor gÃ¶rev avantaj"},
{id:604,name:"M4A1",price:190,info:"Elite gÃ¶rev"},
{id:605,name:"Shotgun",price:140,info:"YakÄ±n dÃ¶vÃ¼ÅŸ"},
{id:606,name:"Susturuculu",price:90,info:"Risk dÃ¼ÅŸÃ¼rÃ¼r"},
{id:607,name:"Sniper",price:220,info:"Boss gÃ¶revi"},
{id:608,name:"Taktik BÄ±Ã§ak",price:30,info:"Enerji -1"},
{id:609,name:"El BombasÄ±",price:120,info:"Tek kullanÄ±mlÄ±k"}
];
function openWeapons(){
 showBox("weapons");
 let h="<b>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</b>";
 weapons.forEach(w=>h+=`<button onclick="buy(${w.id})">${w.name} â€“ ${w.price} YTon</button><small>${w.info}</small>`);
 document.getElementById("weapons").innerHTML=h;
}

/* ================= HASTANE ================= */
async function hospital(){
 const {data}=await sb.rpc("hospital_heal",{p_telegram_id:TELEGRAM_ID});
 modifiers.addiction=Math.max(0,modifiers.addiction-5);
 saveModifiers();
 showResult(data?.error||"Ä°yileÅŸtirildin");
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
