<script>
/* ================= ETKÄ° SÄ°STEMÄ° (GENÄ°ÅLETÄ°LMÄ°Å) ================= */

/* ---- GLOBAL STATE ---- */
let modifiers = JSON.parse(localStorage.getItem("modifiers")) || {
 success: 0,
 risk: 0,
 energyBonus: 0,
 addiction: 0,
 weaponDurability: 100
};

function saveModifiers(){
 localStorage.setItem("modifiers",JSON.stringify(modifiers));
}

/* ================= BUY (ETKÄ°LÄ°) ================= */
async function buy(id){
 const {data}=await sb.rpc("buy_item",{
  p_telegram_id:TELEGRAM_ID,
  p_item_id:id
 });

 if(!data?.error){
  applyItemEffect(id);
 }

 showResult(data?.error || "SatÄ±n alÄ±ndÄ±");
}

/* ================= ITEM EFFECTS ================= */
function applyItemEffect(id){

 /* ğŸ”« SÄ°LAHLAR */
 if(id>=600 && id<=699){
  modifiers.success += 5;
  modifiers.risk -= 2;
  modifiers.weaponDurability = 100;
 }

 /* ğŸ¸ Ä°Ã‡KÄ° */
 if(id>=100 && id<=129){
  modifiers.energyBonus += 3;
  modifiers.risk += 1;
 }

 /* â˜• UYUÅTURUCU */
 if(id>=200 && id<=229){
  modifiers.success += 4;
  modifiers.risk += 2;
  modifiers.addiction += 5;
 }

 /* ğŸ’‹ GENEL EV */
 if(id>=300 && id<=599){
  modifiers.success += 6;
  modifiers.energyBonus += 5;
  modifiers.risk += 1;
 }

 saveModifiers();
}

/* ================= GÃ–REV (FULL KONTROL) ================= */
async function doMission(id){

 /* ---- LEVEL KÄ°LÄ°DÄ° ---- */
 const {data:player}=await sb.from("players")
  .select("level").eq("telegram_id",TELEGRAM_ID).single();

 let requiredLevel = Math.floor(id/10); // basit Ã¶lÃ§ek
 if(player.level < requiredLevel){
  showResult("â›” Level yetersiz");
  return;
 }

 /* ---- BAÅARI / RÄ°SK ---- */
 let finalSuccess = 50 + modifiers.success - modifiers.addiction;
 let finalRisk = Math.max(0, 20 + modifiers.risk + modifiers.addiction);

 /* ---- SÄ°LAH ESKÄ°MESÄ° ---- */
 if(modifiers.weaponDurability > 0){
  modifiers.weaponDurability -= 10;
 } else {
  modifiers.success = Math.max(0, modifiers.success-5);
 }

 let roll = Math.random()*100;

 if(roll > finalSuccess){
  modifiers.energyBonus = 0;
  modifiers.success = Math.max(0, modifiers.success-3);
  modifiers.risk += 2;
  saveModifiers();
  showResult("âŒ GÃ¶rev baÅŸarÄ±sÄ±z");
  return;
 }

 /* ---- BACKEND Ã‡AÄRI ---- */
 const {data}=await sb.rpc("do_mission",{
  p_telegram_id:TELEGRAM_ID,
  p_mission_id:id
 });

 /* ---- POLÄ°S BASKINI ---- */
 if(finalRisk > 40 && Math.random()*100 < finalRisk){
  modifiers.success = 0;
  modifiers.energyBonus = 0;
  modifiers.risk = 0;
  saveModifiers();
  showResult("ğŸš¨ Polis BaskÄ±nÄ±! Bonuslar sÄ±fÄ±rlandÄ±");
  return;
 }

 /* ---- BAÄIMLILIK AZALMASI ---- */
 modifiers.addiction = Math.max(0, modifiers.addiction-2);

 saveModifiers();
 showResult(data?.error || "âœ… GÃ¶rev baÅŸarÄ±yla tamamlandÄ±");
}

/* ================= PLAYER GÃ–STERGE ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
  .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("playerInfo").innerHTML=`
 Enerji: ${data.energy + modifiers.energyBonus} |
 YTon: ${data.yton}<br>
 <small>
 ğŸ¯ BaÅŸarÄ±: +${modifiers.success}% |
 âš ï¸ Risk: ${modifiers.risk} |
 â˜ ï¸ BaÄŸÄ±mlÄ±lÄ±k: ${modifiers.addiction} |
 ğŸ”« Silah Durumu: ${modifiers.weaponDurability}%
 </small>`;
}
</script>
