<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1e1e1e;color:#fff;border:none;border-radius:6px;font-size:16px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
.success{color:#4caf50}
.error{color:#ff5252}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="loadShop()">ğŸ›’ SatÄ±n AlÄ±m</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>

<div id="missions" class="box hidden"></div>
<div id="shop" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const TELEGRAM_ID = "162154220";

function hideAll(){
  document.querySelectorAll(".box").forEach(b=>b.classList.add("hidden"));
}

/* ===== PLAYER ===== */
async function loadPlayer(){
  const { data, error } = await sb
    .from("players")
    .select("*")
    .eq("telegram_id", TELEGRAM_ID)
    .single();

  if(error || !data){
    document.getElementById("playerInfo").innerHTML =
      "<div class='error'>Oyuncu bulunamadÄ±</div>";
    return;
  }

  document.getElementById("playerInfo").innerHTML = `
    <b>Karakter:</b> ${data.character}<br>
    <b>Level:</b> ${data.level}<br>
    <b>XP:</b> ${data.xp}<br>
    <b>Enerji:</b> ${data.energy}<br>
    <b>YTon:</b> ${data.yton}
  `;
}

/* ===== MISSIONS ===== */
async function loadMissions(){
  hideAll();
  const box = document.getElementById("missions");
  box.classList.remove("hidden");
  box.innerHTML = "<h3>GÃ¶revler</h3>";

  const { data } = await sb.from("missions").select("*").eq("active", true);

  if(!data || data.length===0){
    box.innerHTML += "<div>GÃ¶rev yok</div>";
    return;
  }

  data.forEach(m=>{
    box.innerHTML += `
      <button onclick="doMission(${m.id})">
        ${m.name}<br>
        Enerji: ${m.energy_cost} | Ã–dÃ¼l: ${m.yton_reward}
      </button>`;
  });
}

async function doMission(id){
  hideAll();
  const r = document.getElementById("result");
  r.classList.remove("hidden");
  r.innerHTML = "GÃ¶rev yapÄ±lÄ±yor...";

  const { data } = await sb.rpc("do_mission",{
    p_telegram_id: TELEGRAM_ID,
    p_mission_id: id
  });

  r.innerHTML = data?.error
    ? `<div class="error">${data.error}</div>`
    : `<div class="success">GÃ¶rev baÅŸarÄ±lÄ±</div>`;

  loadPlayer();
}

/* ===== SHOP ===== */
function loadShop(){
  hideAll();
  const box = document.getElementById("shop");
  box.classList.remove("hidden");
  box.innerHTML = `
    <h3>SatÄ±n AlÄ±m</h3>
    <button onclick="buyItem(1)">ğŸ”« Tabanca â€“ 50</button>
    <button onclick="buyItem(2)">ğŸº Alkol â€“ 10</button>
    <button onclick="buyItem(3)">ğŸ’Š UyuÅŸturucu â€“ 30</button>
  `;
}

async function buyItem(id){
  hideAll();
  const r = document.getElementById("result");
  r.classList.remove("hidden");

  const { data } = await sb.rpc("buy_item",{
    p_telegram_id: TELEGRAM_ID,
    p_item_id: id
  });

  r.innerHTML = data?.error
    ? `<div class="error">${data.error}</div>`
    : `<div class="success">SatÄ±n alÄ±ndÄ±</div>`;

  loadPlayer();
}

/* ===== HOSPITAL ===== */
async function hospital(){
  hideAll();
  const r = document.getElementById("result");
  r.classList.remove("hidden");

  const { data } = await sb.rpc("hospital_heal",{ p_telegram_id: TELEGRAM_ID });

  r.innerHTML = data?.error
    ? `<div class="error">${data.error}</div>`
    : `<div class="success">Ä°yileÅŸtirildin</div>`;

  loadPlayer();
}

/* ===== INIT ===== */
loadPlayer();
</script>

</body>
</html>
