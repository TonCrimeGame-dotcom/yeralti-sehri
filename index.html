<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>YeraltÄ± Åehri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      background:#0b0b0b;
      color:#fff;
      font-family:Arial, sans-serif;
      margin:0;
      padding:20px;
    }
    h1 { text-align:center; }
    button {
      width:100%;
      padding:14px;
      margin:8px 0;
      background:#1e1e1e;
      color:#fff;
      border:none;
      border-radius:6px;
      font-size:16px;
    }
    button:hover { background:#333; }
    .box {
      background:#151515;
      padding:15px;
      border-radius:8px;
      margin-bottom:15px;
    }
    .hidden { display:none; }
    .success { color:#4caf50; }
    .error { color:#f44336; }
  </style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div class="box" id="playerInfo">
  YÃ¼kleniyor...
</div>

<button onclick="show('missions')">ğŸ§¨ GÃ¶revler</button>
<button onclick="show('shop')">ğŸ›’ SatÄ±n AlÄ±m</button>
<button onclick="heal()">ğŸ¥ Hastane</button>

<div id="missions" class="box hidden"></div>
<div id="shop" class="box hidden"></div>

<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const supabase = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const TELEGRAM_ID = "162154220";

/* ================= UI ================= */
function show(id) {
  document.querySelectorAll('.box').forEach(b => b.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* ================= PLAYER ================= */
async function loadPlayer() {
  const { data } = await supabase
    .from("players")
    .select("*")
    .eq("telegram_id", TELEGRAM_ID)
    .single();

  document.getElementById("playerInfo").innerHTML = `
    <b>Karakter:</b> ${data.character}<br>
    <b>Level:</b> ${data.level}<br>
    <b>XP:</b> ${data.xp}<br>
    <b>Enerji:</b> ${data.energy}<br>
    <b>yTon:</b> ${data.yton}
  `;
}

/* ================= MISSIONS ================= */
async function loadMissions() {
  const { data } = await supabase
    .from("missions")
    .select("*")
    .eq("active", true);

  let html = "<h3>GÃ¶revler</h3>";
  data.forEach(m => {
    html += `
      <button onclick="doMission(${m.id})">
        ${m.name}<br>
        âš¡ ${m.energy_cost} | ğŸ¯ Risk %${m.risk_percent} | ğŸ’° ${m.yton_reward}
      </button>
    `;
  });
  document.getElementById("missions").innerHTML = html;
}

/* ================= DO MISSION ================= */
async function doMission(id) {
  const { data } = await supabase.rpc("do_mission", {
    p_telegram_id: TELEGRAM_ID,
    p_mission_id: id
  });

  showResult(data);
  loadPlayer();
}

/* ================= SHOP ================= */
async function loadShop() {
  const items = [
    { id:1, name:"ğŸº Alkol (50 yTon)" },
    { id:2, name:"ğŸ”« Silah (200 yTon)" },
    { id:3, name:"ğŸ’Š UyuÅŸturucu (150 yTon)" }
  ];

  let html = "<h3>SatÄ±n AlÄ±m</h3>";
  items.forEach(i => {
    html += `<button onclick="buy(${i.id})">${i.name}</button>`;
  });
  document.getElementById("shop").innerHTML = html;
}

async function buy(id) {
  const { data } = await supabase.rpc("buy_item", {
    p_telegram_id: TELEGRAM_ID,
    p_item_id: id
  });

  showResult(data);
  loadPlayer();
}

/* ================= HOSPITAL ================= */
async function heal() {
  const { data } = await supabase.rpc("hospital_heal", {
    p_telegram_id: TELEGRAM_ID
  });

  showResult(data);
  loadPlayer();
}

/* ================= RESULT ================= */
function showResult(res) {
  const box = document.getElementById("result");
  box.classList.remove("hidden");
  box.innerHTML = JSON.stringify(res, null, 2);
}

/* ================= INIT ================= */
loadPlayer();
loadMissions();
loadShop();
</script>

</body>
</html>
