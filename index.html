<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1a1a1a;color:#fff;border:none;border-radius:8px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
small{opacity:.7;display:block}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="openPvP()">âš”ï¸ PvP</button>
<button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>

<div id="content" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://hwhscuyudwphnsipibpy.supabase.co",
 "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);
const TELEGRAM_ID="162154220";

/* ================= MODIFIERS ================= */
let modifiers = JSON.parse(localStorage.getItem("modifiers")) || {
 success:0, risk:0, energyBonus:0
};
const saveMod=()=>localStorage.setItem("modifiers",JSON.stringify(modifiers));

/* ================= UI ================= */
function show(html){
 const c=document.getElementById("content");
 c.innerHTML=html;
 c.classList.remove("hidden");
 document.getElementById("result").classList.add("hidden");
}
function showResult(msg){
 document.getElementById("result").innerHTML=msg;
 document.getElementById("result").classList.remove("hidden");
 loadPlayer();
}

/* ================= PLAYER ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
 .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("playerInfo").innerHTML=`
 Level: ${data.level} | XP: ${data.xp}<br>
 Enerji: ${data.energy + (modifiers.energyBonus||0)}<br>
 YTon: ${data.yton}<br>
 <small>BaÅŸarÄ± +${modifiers.success||0}% | Risk ${modifiers.risk||0}</small>
 `;
}

/* ================= BUY ================= */
async function buy(id){
 const {data}=await sb.rpc("buy_item",{p_telegram_id:TELEGRAM_ID,p_item_id:id});
 if(!data?.error){ applyItem(id); }
 showResult(data?.error||"SatÄ±n alÄ±ndÄ±");
}
function applyItem(id){
 if(id>=600){ modifiers.success+=5; modifiers.risk=Math.max(0,modifiers.risk-1); }
 if(id>=100&&id<200){ modifiers.energyBonus+=3; modifiers.risk+=1; }
 if(id>=200&&id<300){ modifiers.success+=4; modifiers.risk+=2; }
 if(id>=300&&id<600){ modifiers.success+=6; modifiers.energyBonus+=5; modifiers.risk+=1; }
 saveMod();
}

/* ================= GÃ–REVLER ================= */
async function loadMissions(){
 const {data}=await sb.from("missions").select("*").eq("active",true);
 if(!data||!data.length){ show("<b>GÃ¶rev yok</b>"); return; }

 let h="<b>ğŸ’£ GÃ¶revler</b>";
 data.forEach(m=>{
  h+=`<button onclick="doMission(${m.id})">${m.name}</button>
      <small>Enerji ${m.energy_cost}</small>`;
 });
 show(h);
}
async function doMission(id){
 let chance=50+(modifiers.success||0);
 if(Math.random()*100>chance){
  modifiers.risk++; saveMod();
  showResult("âŒ GÃ¶rev baÅŸarÄ±sÄ±z");
  return;
 }
 const {data}=await sb.rpc("do_mission",{p_telegram_id:TELEGRAM_ID,p_mission_id:id});
 modifiers.success=Math.max(0,modifiers.success-2);
 modifiers.risk=Math.max(0,modifiers.risk-1);
 modifiers.energyBonus=0;
 saveMod();
 showResult(data?.error||"âœ… GÃ¶rev tamamlandÄ±");
}

/* ================= PvP ZORLUK ================= */
const pvpData={
 easy:{reward:{yton:8,xp:4},penalty:{yton:3,energy:3},
  scenarios:[{img:"https://images.unsplash.com/photo-1581090700227-1e37b190418e",
  text:"Basit kroki. Kasaya giden yol?",options:["Sol","SaÄŸ","HavalandÄ±rma","Avlu"],correct:2}]},
 medium:{reward:{yton:10,xp:6},penalty:{yton:5,energy:5},
  scenarios:[{img:"https://images.unsplash.com/photo-1503424886307-b090341d25d1",
  text:"Mal taÅŸÄ±ma. Hangisi gÃ¼venli?",options:["RÃ¼ÅŸvet","Gece","Arka yol","Sahte plaka"],correct:1}]},
 hard:{reward:{yton:15,xp:10},penalty:{yton:8,energy:8},
  scenarios:[{img:"https://images.unsplash.com/photo-1599058917212-d750089bc07e",
  text:"Sokak satÄ±ÅŸÄ±. DoÄŸru mÃ¼ÅŸteri?",options:["AÃ§Ä±k","TakÄ±m","KÄ±zÄ±l","SarÄ±ÅŸÄ±n"],correct:1}]}
};
let currentPvP=null;

function openPvP(){
 show(`<b>âš”ï¸ PvP</b>
 <button onclick="startPvP('easy')">ğŸŸ¢ Kolay</button>
 <button onclick="startPvP('medium')">ğŸŸ¡ Orta</button>
 <button onclick="startPvP('hard')">ğŸ”´ Zor</button>`);
}
function startPvP(lvl){
 const s=pvpData[lvl].scenarios[0];
 currentPvP={lvl,correct:s.correct};
 let h=`<img src="${s.img}" style="width:100%;border-radius:8px"><br><b>${s.text}</b>`;
 s.options.forEach((o,i)=>h+=`<button onclick="answerPvP(${i})">${o}</button>`);
 show(h);
}
async function answerPvP(c){
 const d=pvpData[currentPvP.lvl];
 if(c===currentPvP.correct){
  await sb.rpc("pvp_reward",{p_telegram_id:TELEGRAM_ID,p_yton:d.reward.yton,p_xp:d.reward.xp});
  showResult("ğŸ† DoÄŸru cevap");
 }else{
  await sb.rpc("pvp_penalty",{p_telegram_id:TELEGRAM_ID,p_yton:d.penalty.yton,p_energy:d.penalty.energy});
  showResult("âŒ YanlÄ±ÅŸ cevap");
 }
}

/* ================= GECE HAYATI ================= */
function openNightlife(){
 show(`<b>ğŸŒƒ Gece HayatÄ±</b>
 <button onclick="show('Gece KulÃ¼bÃ¼ aktif')">ğŸ¸ Gece KulÃ¼bÃ¼</button>
 <button onclick="show('Coffee Shop aktif')">â˜• Coffee Shop</button>
 <button onclick="show('Genel Ev aktif')">ğŸ’‹ Genel Ev</button>`);
}

/* ================= WEAPONS ================= */
function openWeapons(){
 show(`<b>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</b>
 <button onclick="buy(600)">Glock</button>
 <button onclick="buy(601)">AK-47</button>`);
}

/* ================= HOSPITAL ================= */
async function hospital(){
 const {data}=await sb.rpc("hospital_heal",{p_telegram_id:TELEGRAM_ID});
 showResult(data?.error||"â¤ï¸ Ä°yileÅŸtirildin");
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
