<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
  background:#0b0b0b;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:20px;
}
h1{text-align:center;}
button{
  width:100%;
  padding:14px;
  margin:8px 0;
  background:#1e1e1e;
  color:#fff;
  border:none;
  border-radius:6px;
  font-size:16px;
}
button:hover{background:#333;}
.box{
  background:#151515;
  padding:15px;
  border-radius:8px;
  margin-bottom:15px;
}
.hidden{display:none;}
.success{color:#4caf50;}
.error{color:#ff5252;}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="loadShop()">ğŸ›’ SatÄ±n AlÄ±m</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>

<div id="missions" class="box hidden"></div>
<div id="shop" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ========== SUPABASE (DOÄRU TANIM) ========== */
const sb = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const TELEGRAM_ID = "162154220";

/* ========== GENEL ========== */
function hideAll(){
  document.querySelectorAll(".box").forEach(b=>b.classList.add("hidden"));
}

/* ========== PLAYER ========== */
async function loadPlayer(){
  const { data, error } = await sb
    .from("players")
    .select("*")
    .eq("telegram_id", TELEGRAM_ID)
    .single();

  if(error || !data){
    document.getElementById("playerInfo").innerHTML =
      "<div class='error'>Oyuncu bulunamadÄ±</div>";
    return;
  }

  document.getElementById("playerInfo").innerHTML = `
    <b>Karakter:</b> ${data.character}<br>
    <b>Level:</b> ${data.level}<br>
    <b>XP:</b> ${data.xp}<br>
    <b>Enerji:</b> ${data.energy}<br>
    <b>YTon:</b> ${data.yton}
  `;
}

/* ========== MISSIONS ========== */
async function loadMissions(){
  hideAll();
  const box = document.getElementById("missions");
  box.classList.remove("hidden");
  box.innerHTML = "<h3>GÃ¶revler</h3>";

  const { data, error } = await sb
    .from("missions")
    .select("*")
    .eq("active", true);

  if(error || !data || data.length === 0){
    box.innerHTML += "<div>Aktif gÃ¶rev yok</div>";
    return;
  }

  data.forEach(m=>{
    box.innerHTML += `
      <button onclick="doMission(${m.id})">
        ${m.name}<br>
        Enerji: ${m.energy_cost} | Risk: %${m.risk_percent}<br>
        Ã–dÃ¼l: ${m.yton_reward} YTon
      </button>
    `;
  });
}

async function doMission(id){
  hideAll();
  const res = document.getElementById("result");
  res.classList.remove("hidden");
  res.innerHTML = "GÃ¶rev yapÄ±lÄ±yor...";

  const { data, error } = await sb.rpc("do_mission",{
    p_telegram_id: TELEGRAM_ID,
    p_mission_id: id
  });

  if(error || data?.error){
    res.innerHTML = `<div class="error">${error?.message || data.error}</div>`;
  }else{
    res.innerHTML = `<div class="success">GÃ¶rev tamamlandÄ±!</div>`;
  }

  loadPlayer();
}

/* ========== SHOP ========== */
function loadShop(){
  hideAll();
  const box = document.getElementById("shop");
  box.classList.remove("hidden");
  box.innerHTML = "<h3>SatÄ±n AlÄ±m</h3>";

  const items = [
    {id:1, name:"ğŸ”« Tabanca", price:50},
    {id:2, name:"ğŸº Alkol", price:10},
    {id:3, name:"ğŸ’Š UyuÅŸturucu", price:30}
  ];

  items.forEach(i=>{
    box.innerHTML += `
      <button onclick="buyItem(${i.id})">
        ${i.name} â€“ ${i.price} YTon
      </button>
    `;
  });
}

async function buyItem(id){
  hideAll();
  const res = document.getElementById("result");
  res.classList.remove("hidden");
  res.innerHTML = "SatÄ±n alÄ±nÄ±yor...";

  const { data, error } = await sb.rpc("buy_item",{
    p_telegram_id: TELEGRAM_ID,
    p_item_id: id
  });

  if(error || data?.error){
    res.innerHTML = `<div class="error">${error?.message || data.error}</div>`;
  }else{
    res.innerHTML = `<div class="success">SatÄ±n alÄ±m baÅŸarÄ±lÄ±!</div>`;
  }

  loadPlayer();
}

/* ========== HOSPITAL ========== */
async function hospital(){
  hideAll();
  const res = document.getElementById("result");
  res.classList.remove("hidden");
  res.innerHTML = "Tedavi ediliyor...";

  const { data, error } = await sb.rpc("hospital_heal",{
    p_telegram_id: TELEGRAM_ID
  });

  if(error || data?.error){
    res.innerHTML = `<div class="error">${error?.message || data.error}</div>`;
  }else{
    res.innerHTML = `<div class="success">Enerji doldu!</div>`;
  }

  loadPlayer();
}

/* ========== INIT ========== */
loadPlayer();
</script>

</body>
</html>
