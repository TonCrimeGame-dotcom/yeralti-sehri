<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1a1a1a;color:#fff;border:none;border-radius:8px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
small{opacity:.7;display:block}
.locked{opacity:.4}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="openPvP()">âš”ï¸ PvP</button>
<button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>

<div id="content" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://hwhscuyudwphnsipibpy.supabase.co",
 "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);
const TELEGRAM_ID = "162154220";

/* ================= MODIFIERS ================= */
let modifiers = JSON.parse(localStorage.getItem("modifiers")) || {
 success:0, risk:0, energy:0
};
const saveMod=()=>localStorage.setItem("modifiers",JSON.stringify(modifiers));

/* ================= UI ================= */
function show(msg){
 document.getElementById("result").innerHTML=msg;
 document.getElementById("result").classList.remove("hidden");
 loadPlayer();
}
function showBox(html){
 const c=document.getElementById("content");
 c.innerHTML=html;
 c.classList.remove("hidden");
}

/* ================= PLAYER ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
 .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("playerInfo").innerHTML=`
 <b>Level:</b> ${data.level} | <b>XP:</b> ${data.xp}<br>
 <b>Enerji:</b> ${data.energy + modifiers.energy}<br>
 <b>YTon:</b> ${data.yton}<br>
 <small>BaÅŸarÄ± +${modifiers.success}% | Risk ${modifiers.risk}</small>
 `;
}

/* ================= BUY ================= */
async function buy(id){
 const {data}=await sb.rpc("buy_item",{
  p_telegram_id:TELEGRAM_ID,
  p_item_id:id
 });
 if(!data?.error){ applyItem(id); }
 show(data?.error || "SatÄ±n alÄ±ndÄ±");
}

function applyItem(id){
 if(id>=600){ modifiers.success+=5; modifiers.risk-=2; }
 if(id>=100&&id<200){ modifiers.energy+=3; modifiers.risk+=1; }
 if(id>=200&&id<300){ modifiers.success+=4; modifiers.risk+=2; }
 if(id>=300){ modifiers.success+=6; modifiers.energy+=5; }
 saveMod();
}

/* ================= MISSIONS ================= */
async function loadMissions(){
 const {data}=await sb.from("missions").select("*").eq("active",true);
 if(!data||!data.length){ showBox("GÃ¶rev yok"); return; }

 let h="<b>ğŸ’£ GÃ¶revler</b>";
 data.forEach(m=>{
  h+=`
  <button onclick="doMission(${m.id})">
   ${m.name} â€“ Enerji ${m.energy_cost}
  </button>
  <small>${m.description}</small>`;
 });
 showBox(h);
}

async function doMission(id){
 let chance=50+modifiers.success;
 let roll=Math.random()*100;
 if(roll>chance){
  modifiers.success=Math.max(0,modifiers.success-2);
  modifiers.risk+=1;
  saveMod();
  show("âŒ GÃ¶rev baÅŸarÄ±sÄ±z");
  return;
 }
 const {data}=await sb.rpc("do_mission",{
  p_telegram_id:TELEGRAM_ID,
  p_mission_id:id
 });
 modifiers.success=Math.max(0,modifiers.success-1);
 modifiers.risk=Math.max(0,modifiers.risk-1);
 saveMod();
 show(data?.error || "âœ… GÃ¶rev tamamlandÄ±");
}

/* ================= PvP ================= */
function openPvP(){
 showBox(`
 <b>âš”ï¸ PvP</b>
 <button onclick="pvpWin()">KazandÄ±m</button>
 <button onclick="pvpLose()">Kaybettim</button>
 <small>Kazanan +10 YTon | Kaybeden -5 YTon</small>
 `);
}
async function pvpWin(){
 await sb.rpc("pvp_reward",{p_telegram_id:TELEGRAM_ID,p_yton:10,p_xp:5});
 show("ğŸ† PvP KazanÄ±ldÄ±");
}
async function pvpLose(){
 await sb.rpc("pvp_penalty",{p_telegram_id:TELEGRAM_ID,p_yton:5,p_energy:5});
 show("ğŸ’€ PvP Kaybedildi");
}

/* ================= NIGHTLIFE ================= */
function openNightlife(){
 showBox(`
 <b>ğŸŒƒ Gece HayatÄ±</b>
 <button onclick="club()">ğŸ¸ Gece KulÃ¼bÃ¼</button>
 <button onclick="coffee()">â˜• Coffee Shop</button>
 <button onclick="brothel()">ğŸ’‹ Genel Ev</button>
 `);
}
function club(){ let h="<b>ğŸ¸ Gece KulÃ¼bÃ¼</b>";
 for(let i=0;i<30;i++)h+=`<button onclick="buy(${100+i})">Ä°Ã§ki ${i+1}</button>`;
 showBox(h); }
function coffee(){ let h="<b>â˜• Coffee Shop</b>";
 for(let i=0;i<30;i++)h+=`<button onclick="buy(${200+i})">Madde ${i+1}</button>`;
 showBox(h); }
function brothel(){ let h="<b>ğŸ’‹ Genel Ev</b>";
 for(let i=0;i<50;i++)h+=`<button onclick="buy(${300+i})">Hizmet ${i+1}</button>`;
 showBox(h); }

/* ================= WEAPONS ================= */
function openWeapons(){
 let h="<b>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</b>";
 const w=["Glock","AK-47","Uzi","Sniper","Shotgun","BÄ±Ã§ak"];
 w.forEach((n,i)=>h+=`<button onclick="buy(${600+i})">${n}</button>`);
 showBox(h);
}

/* ================= HOSPITAL ================= */
async function hospital(){
 const {data}=await sb.rpc("hospital_heal",{p_telegram_id:TELEGRAM_ID});
 show(data?.error||"ğŸ¥ Ä°yileÅŸtirildin");
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
