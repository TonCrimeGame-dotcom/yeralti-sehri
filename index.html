<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1a1a1a;color:#fff;border:none;border-radius:8px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
small{opacity:.7}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="openPvP()">âš”ï¸ PvP</button>
<button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>

<div id="content" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://hwhscuyudwphnsipibpy.supabase.co",
 "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);
const TELEGRAM_ID="162154220";

/* ================= MODIFIERS ================= */
let modifiers = JSON.parse(localStorage.getItem("modifiers")) || {
 success: 0,
 risk: 0,
 energyBonus: 0
};
function saveModifiers(){
 localStorage.setItem("modifiers",JSON.stringify(modifiers));
}

/* ================= UI ================= */
function show(html){
 const box=document.getElementById("content");
 box.innerHTML=html;
 box.classList.remove("hidden");
 document.getElementById("result").classList.add("hidden");
}
function showResult(msg){
 document.getElementById("result").innerHTML=msg;
 document.getElementById("result").classList.remove("hidden");
 loadPlayer();
}

/* ================= PLAYER ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
  .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("playerInfo").innerHTML=`
 Level: ${data.level} | XP: ${data.xp}<br>
 Enerji: ${data.energy + (modifiers.energyBonus||0)}<br>
 YTon: ${data.yton}<br>
 <small>BaÅŸarÄ± +${modifiers.success||0}% | Risk ${modifiers.risk||0}</small>
 `;
}

/* ================= BUY ================= */
async function buy(id){
 const {data}=await sb.rpc("buy_item",{
  p_telegram_id:TELEGRAM_ID,
  p_item_id:id
 });
 if(!data?.error){
  applyItemEffect(id);
 }
 showResult(data?.error||"SatÄ±n alÄ±ndÄ±");
}

/* ================= ITEM EFFECT ================= */
function applyItemEffect(id){
 if(id>=600){ modifiers.success+=5; modifiers.risk=Math.max(0,modifiers.risk-1); }
 if(id>=100&&id<200){ modifiers.energyBonus+=3; modifiers.risk+=1; }
 if(id>=200&&id<300){ modifiers.success+=4; modifiers.risk+=2; }
 if(id>=300&&id<600){ modifiers.success+=6; modifiers.energyBonus+=5; modifiers.risk+=1; }
 saveModifiers();
}

/* ================= GÃ–REVLER ================= */
async function loadMissions(){
 const {data}=await sb.from("missions").select("*").eq("active",true);
 if(!data||!data.length){
  show("<b>ğŸ’£ GÃ¶revler</b><p>Aktif gÃ¶rev yok</p>");
  return;
 }
 let h="<b>ğŸ’£ GÃ¶revler</b>";
 data.forEach(m=>{
  h+=`<button onclick="doMission(${m.id})">${m.name}</button>
      <small>Enerji ${m.energy_cost}</small>`;
 });
 show(h);
}

async function doMission(id){
 let successChance=50+(modifiers.success||0);
 if(Math.random()*100>successChance){
  modifiers.risk+=1; saveModifiers();
  showResult("âŒ GÃ¶rev baÅŸarÄ±sÄ±z");
  return;
 }
 const {data}=await sb.rpc("do_mission",{
  p_telegram_id:TELEGRAM_ID,
  p_mission_id:id
 });
 modifiers.success=Math.max(0,modifiers.success-2);
 modifiers.risk=Math.max(0,modifiers.risk-1);
 modifiers.energyBonus=0;
 saveModifiers();
 showResult(data?.error||"âœ… GÃ¶rev tamamlandÄ±");
}

/* ================= PvP (GERÃ‡EK) ================= */
const pvpQuestions=[
 {
  q:"Patron 1900 doÄŸumlu, evlilik 1932. Kasa ÅŸifresi?",
  o:["1900","1932","1934","1885"],
  c:1
 },
 {
  q:"Hapishanede en kÄ±sa yol?",
  o:["A","B","C","D"],
  c:2
 },
 {
  q:"Ä°rlanda satÄ±ÅŸÄ± iÃ§in doÄŸru kiÅŸi?",
  o:["AÃ§Ä±k ten","Esmer","KÄ±zÄ±l","SarÄ±ÅŸÄ±n"],
  c:0
 }
];

function openPvP(){
 const q=pvpQuestions[Math.floor(Math.random()*pvpQuestions.length)];
 let h=`<b>âš”ï¸ PvP</b><p>${q.q}</p>`;
 q.o.forEach((x,i)=>{
  h+=`<button onclick="answerPvP(${i},${q.c})">${x}</button>`;
 });
 show(h);
}

async function answerPvP(sel,cor){
 if(sel===cor){
  await sb.rpc("pvp_reward",{p_telegram_id:TELEGRAM_ID,p_yton:10,p_xp:5});
  showResult("ğŸ† DoÄŸru! +10 YTon");
 }else{
  await sb.rpc("pvp_penalty",{p_telegram_id:TELEGRAM_ID,p_yton:5,p_energy:5});
  showResult("âŒ YanlÄ±ÅŸ! -5 YTon");
 }
}

/* ================= GECE HAYATI ================= */
function openNightlife(){
 show(`<b>ğŸŒƒ Gece HayatÄ±</b>
 <button onclick="openClub()">ğŸ¸ Gece KulÃ¼bÃ¼</button>
 <button onclick="openCoffee()">â˜• Coffee Shop</button>
 <button onclick="openBrothel()">ğŸ’‹ Genel Ev</button>`);
}

function openClub(){ show("<b>ğŸ¸ Gece KulÃ¼bÃ¼</b><p>Ä°Ã§kiler aktif</p>"); }
function openCoffee(){ show("<b>â˜• Coffee Shop</b><p>Maddeler aktif</p>"); }
function openBrothel(){ show("<b>ğŸ’‹ Genel Ev</b><p>Karakterler aktif</p>"); }

/* ================= WEAPONS ================= */
function openWeapons(){
 show(`<b>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</b>
 <button onclick="buy(600)">Glock 19 â€“ 50 YTon</button>
 <button onclick="buy(601)">AK-47 â€“ 160 YTon</button>`);
}

/* ================= HASTANE ================= */
async function hospital(){
 const {data}=await sb.rpc("hospital_heal",{p_telegram_id:TELEGRAM_ID});
 showResult(data?.error||"â¤ï¸ Ä°yileÅŸtirildin");
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
