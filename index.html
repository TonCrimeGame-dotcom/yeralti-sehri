<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1a1a1a;color:#fff;border:none;border-radius:8px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
small{opacity:.7;display:block}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="openPvP()">âš”ï¸ PvP</button>
<button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>

<div id="content" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://hwhscuyudwphnsipibpy.supabase.co",
 "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);
const TELEGRAM_ID="162154220";

/* ================= MODIFIERS (GEÃ‡Ä°CÄ° BONUS) ================= */
let modifiers = JSON.parse(localStorage.getItem("modifiers")) || {
 success:0,
 risk:0,
 energyBonus:0
};
const saveMod=()=>localStorage.setItem("modifiers",JSON.stringify(modifiers));

/* ================= UI ================= */
function show(html){
 const c=document.getElementById("content");
 c.innerHTML=html;
 c.classList.remove("hidden");
 document.getElementById("result").classList.add("hidden");
}
function showResult(msg){
 document.getElementById("result").innerHTML=msg;
 document.getElementById("result").classList.remove("hidden");
 loadPlayer();
}

/* ================= PLAYER ================= */
async function loadPlayer(){
 const {data}=await sb.from("players")
  .select("*").eq("telegram_id",TELEGRAM_ID).single();
 if(!data)return;

 document.getElementById("playerInfo").innerHTML=`
 <b>Level:</b> ${data.level} | <b>XP:</b> ${data.xp}<br>
 <b>Enerji:</b> ${data.energy + (modifiers.energyBonus||0)}<br>
 <b>YTon:</b> ${data.yton}<br>
 <small>BaÅŸarÄ± +${modifiers.success}% | Risk ${modifiers.risk}</small>
 `;
}

/* ================= BUY ================= */
async function buy(id){
 const {data}=await sb.rpc("buy_item",{p_telegram_id:TELEGRAM_ID,p_item_id:id});
 if(!data?.error){ applyItem(id); }
 showResult(data?.error || "SatÄ±n alÄ±ndÄ±");
}

/* ================= ITEM ETKÄ°LERÄ° ================= */
function applyItem(id){
 // Silahlar
 if(id>=600 && id<700){
  modifiers.success+=5;
  modifiers.risk=Math.max(0,modifiers.risk-1);
 }
 // Alkol
 if(id>=100 && id<200){
  modifiers.energyBonus+=3;
  modifiers.risk+=1;
 }
 // UyuÅŸturucu
 if(id>=200 && id<300){
  modifiers.success+=4;
  modifiers.risk+=2;
 }
 // Genel Ev
 if(id>=300 && id<600){
  modifiers.energyBonus+=5;
  modifiers.success+=6;
 }
 saveMod();
}

/* ================= GÃ–REVLER ================= */
async function loadMissions(){
 const {data}=await sb.from("missions").select("*").eq("active",true);
 if(!data||!data.length){
  show("<b>ğŸ’£ Aktif gÃ¶rev yok</b>");
  return;
 }
 let h="<b>ğŸ’£ GÃ¶revler</b>";
 data.forEach(m=>{
  h+=`<button onclick="doMission(${m.id})">${m.name}</button>
      <small>Enerji ${m.energy_cost}</small>`;
 });
 show(h);
}

async function doMission(id){
 let chance=50+modifiers.success;
 if(Math.random()*100>chance){
  modifiers.risk++; saveMod();
  showResult("âŒ GÃ¶rev baÅŸarÄ±sÄ±z");
  return;
 }
 const {data}=await sb.rpc("do_mission",{p_telegram_id:TELEGRAM_ID,p_mission_id:id});
 modifiers.success=Math.max(0,modifiers.success-2);
 modifiers.risk=Math.max(0,modifiers.risk-1);
 modifiers.energyBonus=0;
 saveMod();
 showResult(data?.error||"âœ… GÃ¶rev tamamlandÄ±");
}

/* ================= PvP (ZORLUK + EKONOMÄ°) ================= */
const pvpData={
 easy:{reward:{yton:8,xp:4},penalty:{yton:3,energy:3}},
 medium:{reward:{yton:10,xp:6},penalty:{yton:5,energy:5}},
 hard:{reward:{yton:15,xp:10},penalty:{yton:8,energy:8}}
};
let currentPvP=null;

function openPvP(){
 show(`<b>âš”ï¸ PvP</b>
 <button onclick="startPvP('easy')">ğŸŸ¢ Kolay</button>
 <button onclick="startPvP('medium')">ğŸŸ¡ Orta</button>
 <button onclick="startPvP('hard')">ğŸ”´ Zor</button>`);
}

function startPvP(level){
 currentPvP=level;
 show(`<b>âš”ï¸ PvP (${level})</b>
 <button onclick="answerPvP(true)">DoÄŸru</button>
 <button onclick="answerPvP(false)">YanlÄ±ÅŸ</button>
 <small>Bu versiyon test amaÃ§lÄ±dÄ±r</small>`);
}

async function answerPvP(success){
 const d=pvpData[currentPvP];
 if(success){
  await sb.rpc("pvp_reward",{p_telegram_id:TELEGRAM_ID,p_yton:d.reward.yton,p_xp:d.reward.xp});
  showResult("ğŸ† PvP KazanÄ±ldÄ±");
 }else{
  await sb.rpc("pvp_penalty",{p_telegram_id:TELEGRAM_ID,p_yton:d.penalty.yton,p_energy:d.penalty.energy});
  showResult("âŒ PvP Kaybedildi");
 }
}

/* ================= GECE HAYATI ================= */
function openNightlife(){
 show(`<b>ğŸŒƒ Gece HayatÄ±</b>
 <button onclick="openClub()">ğŸ¸ Gece KulÃ¼bÃ¼</button>
 <button onclick="openCoffee()">â˜• Coffee Shop</button>
 <button onclick="openBrothel()">ğŸ’‹ Genel Ev</button>`);
}

function openClub(){ show("<b>ğŸ¸ Gece KulÃ¼bÃ¼</b><p>30 iÃ§ki satÄ±ÅŸta</p>"); }
function openCoffee(){ show("<b>â˜• Coffee Shop</b><p>30 madde satÄ±ÅŸta</p>"); }
function openBrothel(){ show("<b>ğŸ’‹ Genel Ev</b><p>50 kiÅŸi aktif</p>"); }

/* ================= SÄ°LAH KAÃ‡AKÃ‡ISI ================= */
const weapons=[
 {id:600,name:"Taktik BÄ±Ã§ak",price:30},
 {id:601,name:"MuÅŸta",price:40},
 {id:602,name:"Glock 19",price:80},
 {id:603,name:"Desert Eagle",price:120},
 {id:604,name:"Uzi",price:200},
 {id:605,name:"MP5",price:300},
 {id:606,name:"AK-47",price:500},
 {id:607,name:"M4A1",price:650},
 {id:608,name:"M60",price:1000},
 {id:609,name:"PKM",price:1200},
 {id:610,name:"Dragunov",price:2000},
 {id:611,name:"AWM",price:2500},
 {id:612,name:"El BombasÄ±",price:150},
 {id:613,name:"Sis BombasÄ±",price:100},
 {id:614,name:"Ã‡elik Yelek",price:400}
];

function openWeapons(){
 let h="<b>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</b>";
 weapons.forEach(w=>{
  h+=`<button onclick="buy(${w.id})">${w.name} â€“ ${w.price} YTon</button>`;
 });
 show(h);
}

/* ================= HASTANE ================= */
async function hospital(){
 const {data}=await sb.rpc("hospital_heal",{p_telegram_id:TELEGRAM_ID});
 showResult(data?.error||"â¤ï¸ Ä°yileÅŸtirildin");
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
