<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>YeraltÄ± Åehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
h1{text-align:center}
button{width:100%;padding:14px;margin:8px 0;background:#1a1a1a;color:#fff;border:none;border-radius:8px;font-size:15px}
button:hover{background:#333}
.box{background:#151515;padding:15px;border-radius:8px;margin-bottom:15px}
.hidden{display:none}
.success{color:#4caf50}
.error{color:#f44336}
small{color:#aaa}
</style>
</head>

<body>

<h1>ğŸ”¥ YeraltÄ± Åehri</h1>

<div id="playerInfo" class="box">YÃ¼kleniyor...</div>

<button onclick="loadMissions()">ğŸ’£ GÃ¶revler</button>
<button onclick="loadMarket()">ğŸ›’ Market</button>
<button onclick="hospital()">ğŸ¥ Hastane</button>
<button onclick="openNightlife()">ğŸŒƒ Gece HayatÄ±</button>
<button onclick="openWeapons()">ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</button>

<div id="missions" class="box hidden"></div>
<div id="market" class="box hidden"></div>
<div id="nightlife" class="box hidden"></div>
<div id="weapons" class="box hidden"></div>
<div id="result" class="box hidden"></div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);
const TELEGRAM_ID = "162154220";

/* ================= UI ================= */
function showBox(id){
  document.querySelectorAll(".box").forEach(b=>b.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
function showResult(msg,err=false){
  showBox("result");
  document.getElementById("result").innerHTML =
    `<span class="${err?'error':'success'}">${msg}</span>`;
}

/* ================= PLAYER ================= */
async function loadPlayer(){
  const { data } = await sb.from("players")
    .select("*").eq("telegram_id", TELEGRAM_ID).single();
  if(!data) return;
  document.getElementById("playerInfo").innerHTML =
    `<b>Karakter:</b> ${data.character}<br>
     <b>Enerji:</b> ${data.energy} |
     <b>YTon:</b> ${data.yton}`;
}

/* ================= BUY ================= */
async function buy(id){
  const { data } = await sb.rpc("buy_item",{
    p_telegram_id: TELEGRAM_ID,
    p_item_id: id
  });
  showResult(data?.error ?? "SatÄ±n alÄ±ndÄ±", !!data?.error);
  loadPlayer();
}

/* ================= GÃ–REVLER ================= */
async function loadMissions(){
  showBox("missions");
  const box=document.getElementById("missions");
  box.innerHTML="<b>ğŸ’£ GÃ¶revler</b>";

  const { data } = await sb.from("missions")
    .select("*").eq("active",true);

  if(!data || data.length===0){
    box.innerHTML+="<p>GÃ¶rev yok</p>"; return;
  }

  data.forEach(m=>{
    box.innerHTML+=`
      <button onclick="doMission(${m.id})">
        ${m.name} | Enerji ${m.energy_cost}
      </button>`;
  });
}
async function doMission(id){
  const { data } = await sb.rpc("do_mission",{
    p_telegram_id: TELEGRAM_ID,
    p_mission_id: id
  });
  showResult(data?.error ?? "GÃ¶rev tamamlandÄ±", !!data?.error);
  loadPlayer();
}

/* ================= MARKET ================= */
function loadMarket(){
  showBox("market");
  document.getElementById("market").innerHTML=`
    <b>ğŸ›’ Market</b>
    <button onclick="buy(1)">ğŸº Alkol â€“ 10</button>
    <button onclick="buy(2)">ğŸ’Š UyuÅŸturucu â€“ 30</button>
  `;
}

/* ================= HASTANE ================= */
async function hospital(){
  const { data } = await sb.rpc("hospital_heal",{p_telegram_id: TELEGRAM_ID});
  showResult(data?.error ?? "Ä°yileÅŸtirildin", !!data?.error);
  loadPlayer();
}

/* ================= GECE HAYATI (SABÄ°T) ================= */
function openNightlife(){
  showBox("nightlife");
  document.getElementById("nightlife").innerHTML = `
    <b>ğŸŒƒ Gece HayatÄ±</b>
    <button onclick="openClub()">ğŸ¸ Gece KulÃ¼bÃ¼</button>
    <button onclick="openCoffee()">â˜• Coffee Shop</button>
    <button onclick="openBrothel()">ğŸ’‹ Genel Ev</button>
  `;
}

/* ====== GECE KULÃœBÃœ â€“ 30 Ä°Ã‡KÄ° ====== */
const drinks=[...Array(30)].map((_,i)=>`Ã–zel Ä°Ã§ki ${i+1}`);
function openClub(){
  let h="<b>ğŸ¸ Gece KulÃ¼bÃ¼</b>";
  drinks.forEach((d,i)=>{
    h+=`<button onclick="buy(${100+i})">${d} | Enerji +${2+i%4} â€“ ${10+i*2} YTon</button>`;
  });
  h+=`<button onclick="openNightlife()">â¬… Geri</button>`;
  document.getElementById("nightlife").innerHTML=h;
}

/* ====== COFFEE SHOP â€“ 30 MADDE ====== */
const drugs=[...Array(30)].map((_,i)=>`Madde ${i+1}`);
function openCoffee(){
  let h="<b>â˜• Coffee Shop</b>";
  drugs.forEach((d,i)=>{
    h+=`<button onclick="buy(${200+i})">${d} | XP +${3+i%6} â€“ ${30+i*3} YTon</button>`;
  });
  h+=`<button onclick="openNightlife()">â¬… Geri</button>`;
  document.getElementById("nightlife").innerHTML=h;
}

/* ====== GENEL EV â€“ 50 KARAKTER ====== */
const brothel=[...Array(50)].map((_,i)=>`Ã–zel Karakter ${i+1}`);
function openBrothel(){
  let h="<b>ğŸ’‹ Genel Ev</b>";
  brothel.forEach((n,i)=>{
    h+=`<button onclick="buy(${300+i})">${n} â€“ ${30+i} YTon</button>`;
  });
  h+=`<button onclick="openNightlife()">â¬… Geri</button>`;
  document.getElementById("nightlife").innerHTML=h;
}

/* ================= SÄ°LAH KAÃ‡AKÃ‡ISI ================= */
function openWeapons(){
  showBox("weapons");
  document.getElementById("weapons").innerHTML=`
    <b>ğŸ”« Silah KaÃ§akÃ§Ä±sÄ±</b>
    <button onclick="buy(401)">ğŸ”« Tabanca â€“ 50</button>
    <button onclick="buy(402)">ğŸ”ª BÄ±Ã§ak â€“ 20</button>
  `;
}

/* ================= INIT ================= */
loadPlayer();
</script>

</body>
</html>
