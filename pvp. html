<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>PvP | Yeraltƒ± ≈ûehri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
  background:#0b0b0b;
  color:#fff;
  font-family:Arial;
  padding:20px
}
button{
  width:100%;
  padding:14px;
  margin:8px 0;
  background:#1a1a1a;
  color:#fff;
  border:none;
  border-radius:8px
}
button:hover{background:#333}
.box{
  background:#151515;
  padding:15px;
  border-radius:8px;
  margin-bottom:15px
}
img{border-radius:8px}
</style>
</head>

<body>

<h2>‚öîÔ∏è PvP</h2>

<div id="pvp" class="box">Y√ºkleniyor...</div>

<button onclick="history.back()">‚¨Ö Ana Men√º</button>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://hwhscuyudwphnsipibpy.supabase.co",
  "PUBLIC_ANON_KEY" // buraya anon key
);

const TELEGRAM_ID = "162154220";
let startTime = 0;

/* ================= LOAD PvP ================= */
async function loadPvP(){
  const {data,error} = await sb
    .from("pvp_questions")
    .select("*")
    .eq("active", true)
    .order("id", {ascending:false})
    .limit(1)
    .single();

  if(error || !data){
    document.getElementById("pvp").innerHTML =
      "‚ùå PvP sorusu bulunamadƒ±";
    return;
  }

  startTime = Date.now();

  document.getElementById("pvp").innerHTML = `
    ${data.image_url ? `<img src="${data.image_url}" style="width:100%">` : ""}
    <p><b>${data.question}</b></p>

    <button onclick="answerPvP(${data.id},'A')">A) ${data.option_a}</button>
    <button onclick="answerPvP(${data.id},'B')">B) ${data.option_b}</button>
    <button onclick="answerPvP(${data.id},'C')">C) ${data.option_c}</button>
    <button onclick="answerPvP(${data.id},'D')">D) ${data.option_d}</button>
  `;
}

/* ================= ANSWER ================= */
async function answerPvP(questionId, answer){
  const time = Math.floor((Date.now() - startTime)/1000);

  const {data,error} = await sb.rpc("pvp_answer",{
    p_telegram_id: TELEGRAM_ID,
    p_question_id: questionId,
    p_answer: answer,
    p_time: time
  });

  if(error){
    document.getElementById("pvp").innerHTML =
      "‚ùå Hata: " + error.message;
    return;
  }

  document.getElementById("pvp").innerHTML =
    data.result === "win"
    ? `üèÜ Kazandƒ±n!<br>+${data.yton} YTon<br>+${data.xp} XP`
    : `‚ùå Kaybettin!<br>${data.yton} YTon`;
}

loadPvP();
</script>

</body>
</html>
