<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>PvP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
  background:#0b0b0b;
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  padding:15px;
}
.box{
  background:#151515;
  border-radius:10px;
  padding:15px;
  margin-bottom:15px;
}
button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:8px;
  background:#222;
  color:#fff;
  font-size:16px;
}
button:hover{background:#333}
img{max-width:100%;border-radius:8px;margin:10px 0}
.result{font-size:18px;text-align:center}
.back{background:#500}
</style>
</head>

<body>

<div class="box" id="pvpBox">
  <h2>‚öîÔ∏è PvP</h2>
  <div id="content">Y√ºkleniyor...</div>
</div>

<button class="back" onclick="history.back()">‚¨Ö Ana Men√º</button>

<!-- SUPABASE -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
// ================== AYARLAR ==================
const SUPABASE_URL = "https://hwhscuyudwphnsipibpy.supabase.co";
const SUPABASE_KEY = "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu";
const TELEGRAM_ID = "162154220";
// =============================================

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let startTime = 0;

// PvP Sorusu Y√ºkle
async function loadPvP(){
  const { data, error } = await sb
    .from("pvp_questions")
    .select("*")
    .eq("active", true)
    .order("id", { ascending: false })
    .limit(1)
    .single();

  if(error){
    document.getElementById("content").innerHTML =
      "<div class='result'>‚ùå Soru y√ºklenemedi</div>";
    return;
  }

  startTime = Date.now();

  document.getElementById("content").innerHTML = `
    ${data.image_url ? `<img src="${data.image_url}">` : ``}
    <p><b>${data.question}</b></p>
    <button onclick="answerPvP(${data.id},'A')">A) ${data.option_a}</button>
    <button onclick="answerPvP(${data.id},'B')">B) ${data.option_b}</button>
    <button onclick="answerPvP(${data.id},'C')">C) ${data.option_c}</button>
    <button onclick="answerPvP(${data.id},'D')">D) ${data.option_d}</button>
  `;
}

// Cevap Ver
async function answerPvP(questionId, answer){
  const timeSpent = Math.floor((Date.now() - startTime) / 1000);

  const { data, error } = await sb.rpc("pvp_answer", {
    p_telegram_id: TELEGRAM_ID,
    p_question_id: questionId,
    p_answer: answer,
    p_time: timeSpent
  });

  if(error){
    document.getElementById("content").innerHTML =
      "<div class='result'>‚ùå Sunucu hatasƒ±</div>";
    return;
  }

  if(data.result === "win"){
    document.getElementById("content").innerHTML = `
      <div class="result">üèÜ Kazandƒ±n<br>
      +${data.xp} XP<br>
      +${data.yton} YTon</div>
    `;
  }else{
    document.getElementById("content").innerHTML = `
      <div class="result">‚ùå Kaybettin<br>
      ${data.yton} YTon</div>
    `;
  }
}

// Ba≈ülat
loadPvP();
</script>

</body>
</html>
