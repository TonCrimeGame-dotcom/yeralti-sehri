<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G√∂revler</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
 margin:0;
 background:#0b0b0b;
 color:#fff;
 font-family:Arial, sans-serif;
 padding:20px;
}
h1{text-align:center}
.box{
 background:#151515;
 padding:15px;
 border-radius:12px;
 margin-bottom:15px;
}
button{
 width:100%;
 padding:14px;
 margin:8px 0;
 background:#1a1a1a;
 color:#fff;
 border:none;
 border-radius:10px;
 font-size:15px;
}
button:hover{background:#333}
.back{background:#300}
small{opacity:.7}
</style>
</head>

<body>

<h1>üí£ G√∂revler</h1>

<div id="player" class="box">Y√ºkleniyor...</div>
<div id="missions" class="box">G√∂revler y√ºkleniyor...</div>
<div id="result" class="box" style="display:none"></div>

<button class="back" onclick="history.back()">‚¨Ö Ana Men√º</button>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
 "https://hwhscuyudwphnsipibpy.supabase.co",
 "sb_publishable_dItLcV8z83CvDWuR8nTabA_ImTHGETu"
);

const TELEGRAM_ID = "162154220";

/* ================= PLAYER ================= */
async function loadPlayer(){
 const {data,error} = await sb
  .from("players")
  .select("*")
  .eq("telegram_id",TELEGRAM_ID)
  .single();

 if(error){
  document.getElementById("player").innerHTML="Oyuncu bulunamadƒ±";
  return;
 }

 document.getElementById("player").innerHTML = `
  <b>Level:</b> ${data.level || 1}<br>
  <b>XP:</b> ${data.xp || 0}<br>
  <b>Enerji:</b> ${data.energy || 0}<br>
  <b>YTon:</b> ${data.yton || 0}
 `;
}

/* ================= G√ñREVLER ================= */
async function loadMissions(){
 const box = document.getElementById("missions");

 const {data,error} = await sb
  .from("missions")
  .select("*")
  .eq("active",true);

 if(error){
  box.innerHTML = "G√∂revler y√ºklenemedi";
  return;
 }

 if(!data.length){
  box.innerHTML = "Aktif g√∂rev yok";
  return;
 }

 let html = "<b>Aktif G√∂revler</b>";

 data.forEach(m=>{
  html += `
   <button onclick="doMission(${m.id})">
    ${m.name}<br>
    <small>
     Enerji: ${m.energy_cost} |
     XP: +${m.xp_reward} |
     YTon: +${m.yton_reward}
    </small>
   </button>
  `;
 });

 box.innerHTML = html;
}

/* ================= G√ñREV YAP ================= */
async function doMission(id){
 const resultBox = document.getElementById("result");
 resultBox.style.display="block";
 resultBox.innerHTML="G√∂rev yapƒ±lƒ±yor...";

 const {data,error} = await sb.rpc("do_mission",{
  p_telegram_id: TELEGRAM_ID,
  p_mission_id: id
 });

 if(error){
  resultBox.innerHTML = "‚ùå Hata: " + error.message;
  return;
 }

 if(data.error){
  resultBox.innerHTML = "‚ùå " + data.error;
  return;
 }

 resultBox.innerHTML = `
  ‚úÖ G√∂rev tamamlandƒ±<br>
  +${data.xp} XP<br>
  +${data.yton} YTon<br>
  Enerji -${data.energy_lost}
 `;

 loadPlayer();
 loadMissions();
}

/* ================= INIT ================= */
loadPlayer();
loadMissions();
</script>

</body>
</html>
